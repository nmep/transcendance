<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Settings - Transcendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
  <h1>Paramètres</h1>
  <div id="tfa-area" class="my-4">
    <!-- Ici on va injecter le bouton "Activer" ou "Désactiver" -->
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // 1. Appeler l'endpoint qui retourne si la TFA est activée
  fetch("http://localhost:8000/api/auth/tfa_status", { credentials: "include" })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log("Statut 2FA =", data);
    const tfaArea = document.getElementById("tfa-area");

    if (data.enabled) {
      // 2FA activée => affiche un bouton Désactiver
      tfaArea.innerHTML = `
        <p>La double authentification est activée.</p>
        <button class="btn btn-warning" id="disable-2fa-btn">
          Désactiver la 2FA
        </button>
      `;
      document.getElementById("disable-2fa-btn").addEventListener("click", disableTFA);

    } else {
      // 2FA non activée => affiche un bouton Activer
      tfaArea.innerHTML = `
        <p>La double authentification n'est pas activée.</p>
        <button class="btn btn-primary" id="enable-2fa-btn">
          Activer la 2FA
        </button>
      `;
      document.getElementById("enable-2fa-btn").addEventListener("click", enableTFA);
    }
  })
  .catch(err => console.error("Erreur statut TFA:", err));
});

// Fonction pour désactiver la TFA
function disableTFA() {
  if (confirm("Voulez-vous vraiment désactiver la 2FA ?")) {
    fetch("http://localhost:8000/api/tfa/disable", {
      method: "POST",
      credentials: "include"
    })
    .then(resp => {
      if (!resp.ok) {
        throw new Error(`HTTP error: ${resp.status}`);
      }
      alert("La 2FA a été désactivée.");
      // Reload la page pour mettre à jour l'affichage
      location.reload();
    })
    .catch(err => console.error("Erreur désactivation TFA:", err));
  }
}

// Fonction pour activer la TFA
function enableTFA() {
  // Rediriger l'utilisateur vers la vue Django /account/two_factor/setup/
  // (ou un flow custom)
  window.location.href = "http://localhost:8000/account/two_factor/setup/";
}
</script>

</body>
</html>
